---

- name: confirm pulumi exists
  stat:
    path: /usr/local/bin/pulumi
    get_checksum: false
    get_md5: false
  register: pulumi_exists

# https://www.pulumi.com/docs/get-started/install/versions/
- name: download pulumi
  shell: >
    curl -L "https://get.pulumi.com/releases/sdk/pulumi-v{{ pulumi_version }}-linux-x64.tar.gz" -o /tmp/pulumi-linux-x64.tar.gz
  when: not pulumi_exists.stat.exists

- name: unzip pulumi
  shell: tar -zxvf /tmp/pulumi-linux-x64.tar.gz
  args:
    chdir: "{{ ansible_home }}/"
  when: not pulumi_exists.stat.exists

- name: chmod pulumi dir
  shell: chmod "{{ ansible_home }}/pulumi"
  when: not pulumi_exists.stat.exists

- name: copy pulumi
  become: yes
  shell: cp "{{ ansible_home }}/pulumi/*" /usr/local/bin/
  when: not pulumi_exists.stat.exists

- name: remove pulumi tmp
  file:
    path: /tmp/pulumi-linux-x64.tar.gz
    state: absent
  when: not pulumi_exists.stat.exists

- name: remove pulumi tmp directory
  file:
    path: "{{ ansible_home }}/pulumi/"
    state: absent
  when: not pulumi_exists.stat.exists
