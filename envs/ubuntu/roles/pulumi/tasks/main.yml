---

- name: confirm pulumi exists
  stat:
    path: /usr/local/bin/pulumi
    get_checksum: false
    get_md5: false
  register: pulumi_exists

# https://www.pulumi.com/docs/get-started/install/versions/
- name: download pulumi
  shell: >
    curl -L "https://get.pulumi.com/releases/sdk/pulumi-v{{ pulumi_version }}-linux-x64.tar.gz" -o /tmp/pulumi-linux-x64.tar.gz
  when: not pulumi_exists.stat.exists

- name: unzip pulumi
  become: yes
  unarchive:
    src: /tmp/pulumi-linux-x64.tar.gz
    dest: "{{ ansible_home }}/"
    remote_src: yes
  when: not pulumi_exists.stat.exists

- name: copy pulumi
  become: yes
  shell: cp "{{ ansible_home }}/pulumi/*" /usr/local/bin/.
  when: not pulumi_exists.stat.exists

- name: remove pulumi tmp
  file:
    path: /tmp/pulumi-linux-x64.tar.gz
    state: absent
  when: not pulumi_exists.stat.exists

- name: remove pulumi tmp directory
  file:
    path: {{ ansible_home }}/pulumi/
    state: absent
  when: not pulumi_exists.stat.exists
