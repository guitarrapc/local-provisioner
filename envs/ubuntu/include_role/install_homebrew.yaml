---
- name: "homebrew - clone"
  git:
    repo: https://github.com/Homebrew/brew
    dest: "{{ ansible_home }}/github/Homebrew/brew"
    accept_hostkey: yes

- name: "homebrew - mkdir {{ ansible_home }}/.linuxbrew/bin"
  file:
    path: "{{ ansible_home }}/.linuxbrew/bin"
    state: directory
    force: yes

- name: "homebrew - create linuxbrew symlinks"
  file:
    src: "{{ ansible_home }}/github/Homebrew/brew/bin/brew"
    dest: "{{ ansible_home }}/.linuxbrew/bin/brew"
    state: link

- name: "homebrew - eval shellenv"
  shell: eval $({{ ansible_home }}/.linuxbrew/bin/brew shellenv)
  changed_when: false

- name: "homebrew - install tools"
  homebrew:
    name: "{{ item.name }}"
    state: "{{ item.state }}"
  with_items: "{{ args.packages }}"
  environment:
    # require re-login shell for 1st install, let's manual export shellenv and use it
    HOMEBREW_PREFIX: "{{ ansible_home }}/.linuxbrew"
    HOMEBREW_CELLAR: "{{ ansible_home }}/.linuxbrew/Cellar"
    HOMEBREW_REPOSITORY: "{{ ansible_home }}/github/Homebrew/brew"
    PATH: "{{ ansible_home }}/.linuxbrew/bin:{{ ansible_home }}/.linuxbrew/sbin::{{ ansible_env.PATH }}"
    MANPATH: "{{ ansible_home }}/.linuxbrew/share/man${MANPATH+:$MANPATH}:"
    INFOPATH: "{{ ansible_home }}/.linuxbrew/share/info:${INFOPATH:-}"
