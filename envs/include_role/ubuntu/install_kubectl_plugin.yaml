---
# prepare
- name: "kuberctl_plugin - get os"
  shell: uname | tr '[:upper:]' '[:lower:]'
  register: os_value
  changed_when: false
  check_mode: no
- name: "kuberctl_plugin - register os"
  set_fact: ansible_os='{{ os_value.stdout }}'
- name: "kuberctl_plugin - get arch"
  shell: uname -m | sed -e 's/x86_64/amd64/' -e 's/\(arm\)\(64\)\?.*/\1\2/' -e 's/aarch64$/arm64/'
  register: arch_value
  changed_when: false
  check_mode: no
- name: "kuberctl_plugin - register arch"
  set_fact: ansible_arch='{{ arch_value.stdout }}'
- name: "kuberctl_plugin - debug ansible_os"
  debug:
    msg: "{{ ansible_os }}"
- name: "kuberctl_plugin - debug ansible_arch"
  debug:
    msg: "{{ ansible_arch }}"

# krew: https://krew.sigs.k8s.io/docs/user-guide/setup/install/
- name: "kuberctl_plugin krew - check installed"
  shell: "kubectl krew version 2>&1 | grep {{ args.krew_version }}"
  register: krew_exists
  changed_when: false
  ignore_errors: yes

- name: "kuberctl_plugin krew - tmp directory"
  file:
    path: "/tmp/krew"
    state: directory
  when: krew_exists is failed

- name: "kuberctl_plugin krew - download"
  get_url:
    url: "https://github.com/kubernetes-sigs/krew/releases/download/v{{ args.krew_version }}/krew.tar.gz"
    dest: "/tmp/krew/krew.tar.gz"
  when: krew_exists is failed

- name: "kuberctl_plugin krew - unarchive"
  unarchive:
    src: "/tmp/krew/krew.tar.gz"
    dest: /tmp/krew
    remote_src: yes
  when: krew_exists is failed

- name: "kuberctl_plugin krew - install"
  shell: |
    "/tmp/krew/krew-{{ ansible_os }}_{{ ansible_arch }} install krew"
    export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"
  when: krew_exists is failed

- name: "kuberctl_plugin krew - startup profile.d script"
  become: yes
  blockinfile:
    create: yes
    path: /etc/profile.d/profile_ansible_init_krew.sh
    block: |
      if [[ -d "$HOME/.krew" ]]; then
        export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"
      fi

- name: "kuberctl_plugin {{ item }} - install"
  debug: "{{ item } }"
  with_items: "{{ args.plugins }}"
