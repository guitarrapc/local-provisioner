# gh
# install to /opt/gh, then symlink to /usr/local/bin/gh.
- name: "gh - get version"
  shell: "gh --version"
  register: gh_current
  changed_when: false
  ignore_errors: yes

- name: "gh - current version"
  debug:
    msg: "{{ gh_current.stdout_lines }}"

- name: "gh - check exists"
  shell: gh --version 2>&1 | head -n 1 | grep "{{ args.version }}"
  register: gh_exists
  changed_when: false
  ignore_errors: yes

- name: "gh - mkdir opt/gh"
  become: true
  file:
    path: "/opt/gh"
    state: directory
    force: yes

- name: "gh - download"
  shell: curl -L "https://github.com/cli/cli/releases/download/v{{ args.version }}/gh_{{ args.version }}_linux_amd64.tar.gz" -o /tmp/gh_{{ args.version }}_linux_amd64.tar.gz
  args:
    warn: false
  when: gh_exists is failed

- name: "gh - unzip"
  become: true
  unarchive:
    src: /tmp/gh_{{ args.version }}_linux_amd64.tar.gz
    dest: /opt/gh/
    remote_src: yes
    extra_opts:
      - --strip-components=1 # remove parent directory
  when: gh_exists is failed

- name: "gh - create symlinks"
  become: true
  file:
    src: "/opt/gh/bin/gh"
    dest: "/usr/local/bin/gh"
    state: link

- name: "gh - clean up tmp zip"
  file:
    path: /tmp/gh.tar.gz
    state: absent
  when: gh_exists is failed
